# 技術仕様書

## 1. テクノロジースタック

### 1.1 フロントエンド

| カテゴリ | 技術 | バージョン | 用途 | 選定理由 |
|---------|------|-----------|------|---------|
| フレームワーク | Next.js | 15.x | App Router、RSC対応 | Vercelデプロイ最適化、React 19対応 |
| 言語 | TypeScript | 5.x | 型安全な開発 | 型エラーの早期発見、IDE補完 |
| スタイリング | Tailwind CSS | 3.x | ユーティリティファーストCSS | 高速なUI開発、バンドルサイズ最適化 |
| UIコンポーネント | shadcn/ui | - | Radix UIベースのコンポーネント | カスタマイズ性、アクセシビリティ対応 |
| 状態管理 | Zustand | 4.x | 軽量な状態管理 | Reduxより軽量、ボイラープレート少 |
| ウォレット連携 | Wagmi | 2.x | Ethereumウォレット操作 | React Hooks対応、型安全 |
| Ethereum操作 | Viem | 2.x | 型安全なEthereum操作 | ethers.jsより軽量、Wagmi統合 |

### 1.2 バックエンド

| カテゴリ | 技術 | バージョン | 用途 | 選定理由 |
|---------|------|-----------|------|---------|
| ランタイム | Node.js | 20.x | サーバーサイド実行環境 | LTS、Next.js互換 |
| フレームワーク | Next.js API Routes | 15.x | APIエンドポイント | フロントと統一、Edge Runtime対応 |
| ORM | Prisma | 5.x | データベース操作 | 型生成、マイグレーション管理 |
| バリデーション | Zod | 3.x | スキーマバリデーション | TypeScript統合、AI SDK互換 |
| AI | OpenAI API | - | AIエージェント | 安定性、GPT-4o対応 |
| AI SDK | Vercel AI SDK | 4.x | ツールコール、ストリーミング | 統一API、Next.js最適化 |

### 1.3 AIフレームワーク選定理由

本プロジェクトでは**Vercel AI SDK**を採用し、Mastra等の高機能フレームワークは使用しない。

| 観点 | Vercel AI SDK | Mastra |
|------|--------------|--------|
| 複雑さ | シンプル | 高機能だが複雑 |
| 学習コスト | 低い（ドキュメント豊富） | 高い |
| 必要機能 | ✅ ツールコール、ストリーミング | ○ 過剰な機能 |
| マルチエージェント | 不要 | 強力だが不要 |
| RAG | 不要 | 強力だが不要 |
| デモ適性 | ✅ シンプルで理解しやすい | 複雑すぎる |

**結論:** 本プロジェクトは単一エージェント＋ツールコールで十分。Mastraはマルチエージェント・RAG・複雑なワークフローが必要な場合に検討。

### 1.4 データベース

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| データベース | PostgreSQL | メインデータストア |
| ホスティング | Supabase / Neon | マネージドPostgreSQL |

### 1.5 ブロックチェーン

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| チェーン | Sepolia Testnet | デモ環境 |
| ウォレット | MetaMask | ユーザーウォレット |
| DeFiプロトコル | secured.finance | レンディング |
| DeFi SDK | @secured-finance/sf-client | SDK連携 |
| 決済プロトコル | x402 | ガスレス送金 |
| トークン | JPYC (ERC-20) | ステーブルコイン |

### 1.6 外部サービス

| サービス | 用途 |
|---------|------|
| 楽天商品検索API | 商品情報取得 |
| OpenAI API | AIエージェント（GPT-4o） |

### 1.7 インフラ・デプロイ

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| ホスティング | Vercel | フロントエンド・API |
| データベース | Supabase | PostgreSQL |
| x402 Facilitator | ローカル / VPS | 自前運用 |

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              クライアント                                 │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                    ブラウザ (Chrome / Safari)                      │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐│ │
│  │  │   Next.js   │  │   Wagmi    │  │      MetaMask Extension     ││ │
│  │  │    App      │  │   Viem     │  │                             ││ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘│ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                     HTTPS          │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                              Vercel Edge                                 │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                      Next.js API Routes                            │ │
│  │                                                                    │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │  /api/chat   │  │/api/products │  │     /api/orders          │ │ │
│  │  │              │  │   /search    │  │                          │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │ │
│  │         │                 │                      │                │ │
│  │         ▼                 ▼                      ▼                │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │ OpenAI API   │  │ 楽天API      │  │      Prisma              │ │ │
│  │  │ (GPT-4o)     │  │              │  │                          │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │ │
│  │                                               │                    │ │
│  └───────────────────────────────────────────────│────────────────────┘ │
└──────────────────────────────────────────────────│────────────────────────┘
                                                   │
                                                   ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                              Supabase                                    │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                          PostgreSQL                                │ │
│  │  ┌──────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │ │
│  │  │  users   │  │ conversations│  │   messages   │  │   orders   │ │ │
│  │  └──────────┘  └──────────────┘  └──────────────┘  └────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                           Sepolia Testnet                                │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐ │ │
│  │  │   JPYC Token     │  │ secured.finance  │  │ x402 Facilitator │ │ │
│  │  │   Contract       │  │   Contracts      │  │   (自前運用)     │ │ │
│  │  │                  │  │                  │  │                  │ │ │
│  │  │  ERC-20          │  │  LendingMarket   │  │  localhost:3002  │ │ │
│  │  │  EIP-3009        │  │  TokenVault      │  │                  │ │ │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘ │ │
│  │                                                                    │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.2 通信フロー

```
                  ┌─────────────────────────────────────────────────┐
                  │                    ユーザー操作                   │
                  └─────────────────────────────────────────────────┘
                                         │
            ┌────────────────────────────┼────────────────────────────┐
            │                            │                            │
            ▼                            ▼                            ▼
    ┌───────────────┐           ┌───────────────┐           ┌───────────────┐
    │  チャット入力  │           │ ウォレット接続 │           │  管理者操作   │
    └───────────────┘           └───────────────┘           └───────────────┘
            │                            │                            │
            ▼                            ▼                            │
    ┌───────────────┐           ┌───────────────┐                     │
    │ POST /api/chat│           │  Wagmi/Viem   │                     │
    └───────────────┘           └───────────────┘                     │
            │                            │                            │
            ▼                            ▼                            │
    ┌───────────────┐           ┌───────────────┐                     │
    │  OpenAI API   │           │   MetaMask    │                     │
    │   (意図理解)   │           │  (署名/送信)   │                     │
    └───────────────┘           └───────────────┘                     │
            │                            │                            │
            ├──────┬──────┬──────────────┤                            │
            │      │      │              │                            │
            ▼      ▼      ▼              ▼                            ▼
    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           ┌───────────────┐
    │楽天API  │ │SF SDK   │ │x402     │ │DB更新   │           │ GET/PATCH     │
    │(商品検索)│ │(DeFi)   │ │(送金)   │ │(注文)   │           │ /api/orders   │
    └─────────┘ └─────────┘ └─────────┘ └─────────┘           └───────────────┘
```

## 3. セキュリティ設計

> **注意:** 本セクションはデモ向けの最小限の設計。本番移行時には「3.4 将来の強化項目」を実装する。

### 3.1 認証・認可（デモ版）

| 対象 | 方式 | 詳細 | 本番での強化 |
|------|------|------|-------------|
| ユーザー識別 | ウォレットアドレス | KYC不要、ウォレット接続のみ | SIWE（Sign-In with Ethereum）|
| トランザクション認証 | MetaMask署名 | 秘密鍵はユーザー管理 | - |
| 管理者認証 | Basic認証 + Cookie | デモ用の簡易認証 | OAuth 2.0 / SSO |
| API認証 | 環境変数 | サーバーサイドでAPIキー管理 | API Gateway + Rate Limiting |

### 3.2 データ保護

| データ | 保護方式 |
|--------|----------|
| 秘密鍵 | アプリは保持しない（MetaMask管理） |
| APIキー | 環境変数で管理、クライアントに露出しない |
| 住所情報 | DBに保存、HTTPS通信 |
| 会話履歴 | DBに保存、ウォレットアドレスで分離 |

### 3.3 トランザクションセキュリティ

```
┌─────────────────────────────────────────────────────────────┐
│                   トランザクションフロー                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. フロントエンドでトランザクションデータ生成               │
│     ↓                                                       │
│  2. MetaMaskに送信                                          │
│     ↓                                                       │
│  3. ユーザーが内容を確認・署名                               │
│     ↓                                                       │
│  4. 署名済みトランザクションをブロックチェーンに送信          │
│     ↓                                                       │
│  5. トランザクション完了を確認                               │
│                                                             │
│  ※アプリは秘密鍵にアクセスしない                            │
│  ※すべてのトランザクションはユーザー承認が必要               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 将来の強化項目（本番移行時）

| 項目 | 対策 | 優先度 |
|------|------|--------|
| OWASP Top 10 | XSS/CSRF/SQLi対策の網羅的実装 | 高 |
| レート制限 | API別のレート制限（Redis使用） | 高 |
| 入力バリデーション | 全エンドポイントでZodスキーマ検証 | 高 |
| 監査ログ | 重要操作のログ記録・保存 | 中 |
| x402秘密鍵管理 | AWS Secrets Manager / HashiCorp Vault | 高 |
| WAF | Vercel Edge Middleware / Cloudflare | 中 |
| ペネトレーションテスト | 第三者によるセキュリティ監査 | 低 |

## 4. 環境設定

### 4.1 環境変数

```bash
# .env.local

# Database
DATABASE_URL="postgresql://..."

# AI (OpenAI)
OPENAI_API_KEY="sk-..."

# Rakuten API
RAKUTEN_APP_ID="..."

# Blockchain
NEXT_PUBLIC_CHAIN_ID="11155111"  # Sepolia
NEXT_PUBLIC_JPYC_CONTRACT_ADDRESS="0x..."
NEXT_PUBLIC_SF_SUBGRAPH_URL="https://api.studio.thegraph.com/..."

# x402 Facilitator
X402_FACILITATOR_URL="http://localhost:3002"
X402_FACILITATOR_PRIVATE_KEY="0x..."

# Admin
ADMIN_USERNAME="admin"
ADMIN_PASSWORD="..."
```

### 4.2 チェーン設定

```typescript
// lib/chains.ts
import { sepolia } from "viem/chains";

export const targetChain = sepolia;

export const chainConfig = {
  chainId: 11155111,
  chainName: "Sepolia",
  rpcUrl: "https://sepolia.infura.io/v3/YOUR_KEY",
  blockExplorer: "https://sepolia.etherscan.io",
};
```

### 4.3 コントラクトアドレス

```typescript
// lib/contracts.ts
export const contracts = {
  jpyc: {
    address: "0x..." as `0x${string}`,
    decimals: 18,
  },
  securedFinance: {
    // SDK経由でアクセスするため直接アドレスは不要
    subgraphUrl: process.env.NEXT_PUBLIC_SF_SUBGRAPH_URL,
  },
};
```

## 5. パフォーマンス設計

### 5.1 目標値

| 指標 | 目標 | 備考 |
|------|------|------|
| チャット応答 | 10秒以内 | OpenAI API応答含む |
| 商品検索 | 15秒以内 | 楽天API応答含む |
| 画面初期表示 | 3秒以内 | First Contentful Paint |
| トランザクション確認 | 30秒以内 | Sepolia平均ブロック時間 |

### 5.2 最適化戦略

| 対象 | 戦略 |
|------|------|
| フロントエンド | Next.js App Router、Server Components活用 |
| API | Edge Runtime対応エンドポイント |
| AI応答 | ストリーミングレスポンス |
| データ取得 | SWRによるキャッシュ・再検証 |

## 6. エラーハンドリング

### 6.1 エラー分類

| レベル | 対応 | 例 |
|--------|------|-----|
| 致命的 | アプリ停止、エラー画面表示 | DB接続失敗 |
| 重大 | 機能停止、ユーザー通知 | トランザクション失敗 |
| 警告 | リトライ、代替処理 | API一時エラー |
| 情報 | ログ記録のみ | パフォーマンス低下 |

### 6.2 エラー表示

```typescript
// エラーハンドリングの方針
const errorMessages = {
  WALLET_NOT_CONNECTED: "ウォレットを接続してください",
  INSUFFICIENT_BALANCE: "残高が足りません",
  TX_REJECTED: "トランザクションがキャンセルされました",
  TX_FAILED: "トランザクションに失敗しました。再度お試しください",
  API_ERROR: "情報の取得に失敗しました",
  AI_ERROR: "申し訳ありません。もう一度お試しください",
};
```

## 7. 開発・テスト環境

### 7.1 ローカル開発

```bash
# 必要なツール
- Node.js 20.x
- pnpm 8.x
- PostgreSQL 15.x (Docker推奨)

# セットアップ
git clone <repository>
cd jpyc-concierge
pnpm install
cp .env.example .env.local
# 環境変数を設定
pnpm dev
```

### 7.2 x402 Facilitator起動

```bash
# 別ターミナルで
git clone git@github.com:coinbase/x402.git
cd x402/examples/typescript
pnpm install
cd facilitator
# .envを設定
pnpm dev
```

### 7.3 テスト環境

| 対象 | ツール |
|------|--------|
| ユニットテスト | Vitest |
| E2Eテスト | Playwright（実装優先度: 低） |
| API テスト | Postman / Thunder Client |

## 8. デプロイ

### 8.1 本番デプロイ（Vercel）

```bash
# Vercel CLI
vercel --prod

# または GitHub連携で自動デプロイ
```

### 8.2 環境構成

```
┌─────────────────────────────────────────────────────────────┐
│                      Production                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Vercel                          Supabase                   │
│  ┌─────────────────────┐        ┌─────────────────────┐    │
│  │  Next.js App        │        │  PostgreSQL         │    │
│  │  API Routes         │◀──────▶│                     │    │
│  └─────────────────────┘        └─────────────────────┘    │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────┐                                   │
│  │  x402 Facilitator   │  ← VPS or Railway で運用          │
│  │  (別サーバー)        │                                   │
│  └─────────────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 9. 依存関係

### 9.1 package.json（主要パッケージ）

```json
{
  "dependencies": {
    "next": "^15.0.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "openai": "^4.70.0",
    "ai": "^4.0.0",
    "@ai-sdk/openai": "^1.0.0",
    "wagmi": "^2.12.0",
    "viem": "^2.21.0",
    "@tanstack/react-query": "^5.56.0",
    "zustand": "^4.5.0",
    "prisma": "^5.20.0",
    "@prisma/client": "^5.20.0",
    "zod": "^3.23.0",
    "tailwindcss": "^3.4.0",
    "@secured-finance/sf-client": "latest",
    "@secured-finance/sf-graph-client": "latest",
    "@secured-finance/sf-core": "latest",
    "@x402/fetch": "latest"
  },
  "devDependencies": {
    "typescript": "^5.6.0",
    "vitest": "^2.1.0",
    "@types/node": "^20.0.0",
    "@types/react": "^18.0.0"
  }
}
```

## 10. 制約事項

### 10.1 技術的制約

| 制約 | 理由 | 対応 |
|------|------|------|
| MetaMaskのみ対応 | デモ用途のため | WalletConnect対応は将来検討 |
| Sepoliaのみ | テストネット環境 | 本番はEthereum Mainnet |
| x402 Facilitator自前運用 | JPYC対応Facilitatorが公開されていない | ローカルまたはVPSで運用 |
| secured.finance SDK | GitHub Packages認証が必要 | GitHub Token設定が必須 |

### 10.2 運用上の制約（デモ版）

| 制約 | 理由 | 対応 |
|------|------|------|
| 同時接続10人程度 | デモ用途 | 必要に応じてスケール |
| 代理購入が必要 | 楽天がJPYC未対応 | 管理者が手動対応 |
| テストネットのため実際の価値なし | Sepoliaトークン | 本番移行時に対応 |

### 10.3 スケーラビリティロードマップ（将来対応）

```
┌─────────────────────────────────────────────────────────────┐
│              スケーラビリティ段階的対応                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: デモ（現在）                                      │
│  ├─ 同時接続: ~10人                                        │
│  ├─ Vercel Free / Hobby                                    │
│  ├─ Supabase Free                                          │
│  └─ 単一x402 Facilitator                                   │
│                                                             │
│  Phase 2: β版                                              │
│  ├─ 同時接続: ~100人                                       │
│  ├─ Vercel Pro                                             │
│  ├─ Supabase Pro + Connection Pooling (PgBouncer)          │
│  ├─ Redis (Upstash) for session/cache                      │
│  └─ x402 Facilitator on Railway                            │
│                                                             │
│  Phase 3: 本番                                              │
│  ├─ 同時接続: 1000+人                                      │
│  ├─ Vercel Enterprise                                      │
│  ├─ Supabase Enterprise / AWS RDS                          │
│  ├─ Redis Cluster                                          │
│  ├─ CDN (Cloudflare)                                       │
│  └─ 複数リージョンx402 Facilitator                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**ボトルネック分析（本番移行時に対応）:**

| コンポーネント | 潜在的ボトルネック | 対策 |
|---------------|------------------|------|
| OpenAI API | レート制限、レイテンシ | キャッシュ、フォールバック |
| 楽天API | レート制限 | キャッシュ（Redis） |
| PostgreSQL | 接続数上限 | Connection Pooling |
| x402 Facilitator | 単一障害点 | 複数インスタンス化 |
